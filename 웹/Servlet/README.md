# 서블릿

**자바 웹 어플리케이션(Java Web Application)**

WAS에 설치(deploy)되어 동작하는 어플리케이션입니다.

자바 웹 애플리케이션에는 HTML, CSS, 이미지, 자바로 작성된 클래스(Servlet도 포함됨, package, 인터페이스 등), 각종 설정 파일 등이 포함됩니다.

- WAS 에 의해서 동작.

**자바 웹 어플리케이션의 폴더 구조**

[![img](https://cphinf.pstatic.net/mooc/20180124_133/15167752967943AqfC_PNG/1_5_1_____.PNG?type=w760)](https://www.edwith.org/boostcourse-web/lecture/16686/#)

- WEB-INF
  - web.xml
    - 웹어플리케이션에 대한 정보를 가지고 있다.
    - web application의 설정을 위한 deployment descriptor
    - Deploy할 때 Servlet의 정보를 설정해준다.
    - 브라우저가 Java Servlet에 접근하기 위해서는 WAS(Ex. Tomcat)에 필요한 정보를 알려줘야 해당하는 Servlet을 호출할 수 있다.
      - 배포할 Servlet이 무엇인지
      - 해당 Servlet이 어떤 URL에 매핑되는지.



### 서블릿이란?

> 클라이언트 요청을 처리하고 그 결과를 다시 클라이언트에게 전송하는 Servlet 클래스의 구현 규칙을 지킨 자바 프로그램.
>
> (클라이언트의 HTTP요청에 대해 특정 기능을 수행, HTML문서를 생성 등의 응답을 하는 인터넷 서버 프로그램.)
>
> 이를 다시말하면,  **자바를 사용하여 웹을 만들기 위해 필요한 기술**

- 자바 웹 어플리케이션의 구성요소 중 동적인 처리를 하는 프로그램의 역할입니다.
- 서블릿을 정의해보면
  - 서블릿(servlet)은 WAS에 동작하는 JAVA 클래스입니다.
  - 서블릿은 HttpServlet 클래스를 상속받아야 합니다.
  - 서블릿과 JSP로부터 최상의 결과를 얻으려면, 웹 페이지를 개발할 때 이 두 가지(JSP, 서블릿)를 조화롭게 사용해야 합니다.예를 들어, 웹 페이지를 구성하는 화면(HTML)은 JSP로 표현하고, 복잡한 프로그래밍은 서블릿으로 구현합니다.

#### 서블릿 특징

* 클라이언트의 요청에 대해 동적으로 작동하는 웹 어플리케이션 컴포넌트
* html을 사용하여 요청에 응답한다.
* Java Thread를 이용하여 동작한다.
* MVC 패턴에서 Controller로 이용된다.
* HTTP 프로토콜 서비스를 지원하는 javax.servlet.http.HttpServlet 클래스를 상속받는다. UDP보다 속도가 느리다.
* HTML 변경 시 Servlet을 재컴파일해야 하는 단점이 있다.

#### 서블릿 동작 방식

![image](https://user-images.githubusercontent.com/42582516/80619287-795f7480-8a7f-11ea-83d5-6d16e8e93b77.png)

1. 사용자(클라이언트)가 URL을 클릭하면 HTTP Request를 Servlet Container로 전송합니다.
2. HTTP Request를 전송받은 Servlet Container는 HttpServletRequest, HttpServletResponse 두 객체를 생성합니다.
3. web.xml은 사용자가 요청한 URL을 분석하여 어느 서블릿에 대해 요청을 한 것인지 찾습니다.
4. 해당 서블릿에서 service메소드를 호출한 후 클리아언트의 POST, GET여부에 따라 doGet() 또는 doPost()를 호출합니다.
5. doGet() or doPost() 메소드는 동적 페이지를 생성한 후 HttpServletResponse객체에 응답을 보냅니다.
6. 응답이 끝나면 HttpServletRequest, HttpServletResponse 두 객체를 소멸시킵니다.



### 서블릿 컨테이너

> 서블릿을 관리해주는 역할, 서블릿을 관리해주는 컨테이너

- **통신 지원**
  서블릿과 웹 서버가 통신할 수 있는 손쉬운 방법을 제공한다. 우리가 통신을 한다고 생각할 때 소켓을 만들고, 특정 포트를 리스닝하고, 연결 요청이 들어오면 스트림을 생성해서 요청을 받는다고 알고 있는데 이 과정을 서블릿 컨테이너가 대신해주는 것이다. 서블릿 컨테이너는 이런 통신 과정을 API로 제공하고 있기 때문에 우리가 쉽게 사용할 수 있다.
- **생명주기 관리**
  서블릿 컨테이너가 기동 되는 순간 서블릿 클래스를 로딩해서 인스턴스 화하고, 초기화 메서드를 호출하고, 요청이 들어오면 적절한 서블릿 메서드를 찾아서 호출한다. 만약 서블릿의 생명이 다하는 순간 가비지 컬렉션을 진행한다.
- **멀티스레딩 관리**
  서블릿 컨테이너는 해당 서블릿의 요청이 들어오면 스레드를 생성해서 작업을 수행한다. 즉 동시의 여러 요청이 들어온다면 멀티스레딩 환경으로 동시다발적인 작업을 관리한다.
- **선언적인 보안관리**
  서블릿 컨테이너는 보안 관련된 기능을 지원한다. 따라서 서블릿 코드 안에 보안 관련된 메소드를 구현하지 않아도 된다.
- **JSP 지원**



대표적으로 톰캣이 서블릿 컨테이너

톰캣은 웹서버와 연동하여 실행할 수 있는 자바 환경을 제공하여 자바 서버 페이지(JSP)와 자바 서블릿이 실행할 수 있는 환경을 제공하고 있다.

프로그래머가 작성하는 서블릿 클래스는 추상 클래스 HttpServlet에 있는 메소드 중 클라이언트 사용자가 요청한 정보에 따라 처리해야 할 메소드를 오버라이딩 해서 구현한다.

> doGet() : 클라이언트 HTTP GET 요청에 대해 처리.
>
> doPost() : 클라이언트 HTTP POST 요청에 대해 처리.
>
> doPut() : 클라이언트 HTTP PUT 요청에 대해 처리.
>
> doDelete() : 클라이언트 HTTP DELETE 요청에 대해 처리.
>
> init() : 서블릿의 생명주기 처리로 가장 처음에 실행.
>
> destory() : 서블릿의 생명주기 처리로 서블릿 객체를 메모리에서 제거할 때 마지막으로 실행.



### **서블릿 생명주기 (servlet Life Cycle)**

**서블릿 생성 -> init() -> { service() -> doXxx() } -> destory() -> 서블릿 종료 ( {} 반복 )**

서블릿 클래스 객체가 생성되면 가장 처음에 메소드 init()이 실행되며, 클라이언트의 요청이 들어 올 때마다 service() 메소드가 실행되어 요청에 맞는 메소드 doXxx()를 생행한다. 마지막으로 서버가 종료되거나 서블릿을 더 이상 사용할 필요가 없어 서블릿 객체를 메모리에서 제거할 때, 마지막으로 메소드 destory()가 실행되어 사용하던 자원을 정리하고 종료된다.

init()과 destory()는 서블릿의 생성과 종료 시 단 한 번이 실행되며 service() 메서드는 사용자의 요청이 있을 때마다 반복적으로 실행된다.

![image](https://user-images.githubusercontent.com/42582516/80619374-98f69d00-8a7f-11ea-9829-0ea97bba4b8f.png)

> 1. 클라이언트의 요청이 들어오면 컨테이너는 해당 서블릿이 메모리에 있는지 확인하고, 없을 경우 init()메소드를 호출하여 적재합니다. init()메소드는 처음 한번만 실행되기 때문에, 서블릿의 쓰레드에서 공통적으로 사용해야하는 것이 있다면 오버라이딩하여 구현하면 됩다. 실행 중 서블릿이 변경될 경우, 기존 서블릿을 파괴하고 init()을 통해 새로운 내용을 다시 메모리에 적재합니다.
> 2. init()이 호출된 후 클라이언트의 요청에 따라서 service()메소드를 통해 요청에 대한 응답이 doGet()가 doPost()로 분기됩니다. 이때 서블릿 컨테이너가 클라이언트의 요청이 오면 가장 먼저 처리하는 과정으로 생성된 HttpServletRequest, HttpServletResponse에 의해 request와 response객체가 제공됩니다.
> 3. 컨테이너가 서블릿에 종료 요청을 하면 destroy()메소드가 호출되는데 마찬가지로 한번만 실행되며, 종료시에 처리해야하는 작업들은 destroy()메소드를 오버라이딩하여 구현하면 됩니다.



### JSP(Java Server Page)

Java 코드가 들어가 있는 HTML 코드

>  JSP는 HTML 소스코드 속에 자바 소스코드가 들어가는 구조를 갖는 웹어플리케이션 프로그래밍 기술입니다.
>
>  HTML속에서 자바코드는 <% 소스코드 %> 또는 <%= 소스코드 =%>형태로 들어갑니다

#### JSP의 특징

* 자바 소스코드로 작성된 이 부분은 웹 브라우저로 보내는 것이아니라 웹 서버에서 실행
* 소스코드 수정 시 디자인 부분을 제외하고 자바 소스코드만 수정하면 되기에 효율을 높여줌
* 컴파일과 같은 과정을 할 필요없이 JSP페이지를 작성하여웹 서버의 디렉토리에 추가만 하면 사용이 가능
* JSP는 WAS(Web Application Server)에 의하여 서블릿 클래스로 변환하여 사용되어 집니다. 

#### JSP의 동작 구조

![image](https://user-images.githubusercontent.com/42582516/80619702-05719c00-8a80-11ea-8dae-7d65ae73d4f4.png)

> 웹 서버가 사용자로부터 서블릿에 대한 요청을 받으면 서블릿컨테이너에 그 요청을 넘깁니다. 요청을 받은 컨테이너는 HTTP Request와 HTTP Response 객체를 만들어, 이들을 통해 서블릿 doPost()나 doGet()메소드 중 하나를 호출합니다. 만약 서블릿만 사용하여 사용자가 요청한 웹 페이지를 보여주려면 out 객체의 println 메소드를 사용하여 HTML 문서를 작성해야 하는데 이는 추가/수정을 어렵게 하고, 가독성도 떨어지기 때문에 JSP를 사용하여 비지니스 로직과 프레젠테이션 로직을 분리합니다. 여기서 서블릿은 데이터의 입력, 수정 등에 대한 제어를 JSP에게 넘겨서 프레젠테이션 로직을 수행한 후 컨테이너에게 Response를 전달합니다. 이렇게 만들어진 결과물은 사용자가 해당 페이지를 요청하면 컴파일이 되어 자바파일을 통해 .class 파일이 만들어지고, 두 로직이 결합되어 클래스화 되는것을 확인할 수 있다. 즉, out객체의 println 메소드를 사용해서 구현해야하는 번거로움을 JSP가 대신 수행해줍니다



### Reference

- https://www.edwith.org/boostcourse-web/lecture/16686/
- https://jusungpark.tistory.com/15
- https://mangkyu.tistory.com/14
